rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userPath() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }

    function userRole() {
      return isSignedIn() && exists(userPath()) ? get(userPath()).data.rol : null;
    }

    function hasRole(role) {
      return userRole() == role;
    }

    function isVisitador() {
      return hasRole("VISITADOR");
    }

    function isAuxiliar() {
      return hasRole("AUXILIAR_ADMINISTRATIVA");
    }

    function isBiomedico() {
      return hasRole("INGENIERO_BIOMEDICO");
    }

    function isGerencia() {
      return hasRole("GERENCIA");
    }

    // --- USERS ---
    match /users/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // --- ADMINS (flag para habilitar pantalla Admin) ---
    match /admins/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow create, update, delete: if false;
    }

    // --- PACIENTES ---
    match /pacientes/{id} {
      // VISITADOR: solo puede ver pacientes con asignación activa
      allow read: if isSignedIn() && (!isVisitador() || resource.data.tieneAsignacionActiva == true);
      // escritura solo auxiliar
      allow create, update, delete: if isSignedIn() && isAuxiliar();
    }

    // --- EQUIPOS ---
    match /equipos/{id} {
      // VISITADOR: solo puede ver equipos con asignación activa
      allow read: if isSignedIn() && (!isVisitador() || resource.data.asignadoActivo == true);
      allow create, update, delete: if isSignedIn() && isBiomedico();
    }

    // --- ASIGNACIONES ---
    match /asignaciones/{id} {
      // VISITADOR: solo puede ver asignaciones activas
      allow read: if isSignedIn() && (!isVisitador() || resource.data.estado == "ACTIVA");
      // crear/actualizar solo auxiliar
      allow create, update: if isSignedIn() && isAuxiliar();
      allow delete: if false;
    }

    // --- ACTAS INTERNAS (biomedico -> auxiliar) ---
    match /actas_internas/{id} {
      // No se usan en VISITADOR
      allow read: if isSignedIn() && !isVisitador();
      allow create, update, delete: if false;
    }

    // --- REPORTES (VISITADOR -> BIOMEDICO) ---
    match /reportes_equipos/{id} {
      function asignacionActivaMatch() {
        return request.resource.data.idAsignacion is string
          && exists(/databases/$(database)/documents/asignaciones/$(request.resource.data.idAsignacion))
          && get(/databases/$(database)/documents/asignaciones/$(request.resource.data.idAsignacion)).data.estado == "ACTIVA"
          && get(/databases/$(database)/documents/asignaciones/$(request.resource.data.idAsignacion)).data.idPaciente == request.resource.data.idPaciente
          && get(/databases/$(database)/documents/asignaciones/$(request.resource.data.idAsignacion)).data.idEquipo == request.resource.data.idEquipo;
      }

      // VISITADOR crea reportes (1 sola escritura)
      allow create: if isSignedIn()
        && isVisitador()
        && request.resource.data.estado == "ABIERTO"
        && request.resource.data.creadoPorUid == request.auth.uid
        && request.resource.data.fotos.size() <= 5
        && asignacionActivaMatch();

      // Lectura: biomédico/gerencia pueden ver todo; visitador solo lo suyo
      allow read: if isSignedIn() && (
        isBiomedico()
        || isGerencia()
        || (isVisitador() && resource.data.creadoPorUid == request.auth.uid)
      );

      // Cierre: solo biomédico, y solo para cerrar (no modificar campos base)
      allow update: if isSignedIn()
        && isBiomedico()
        && resource.data.estado == "ABIERTO"
        && request.resource.data.estado == "CERRADO"
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "estado",
          "cerradoAt",
          "cerradoPorUid",
          "cerradoPorNombre",
          "cierreNotas"
        ]);

      allow delete: if false;
    }

    // --- DENY DEFAULT ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
